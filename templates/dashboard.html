<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if user_type == 'admin' %}Admin {% endif %}Dashboard - Drone Application & Research Center</title>

    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">

    <!-- Load theme immediately to prevent flash -->
    <script src="{{ url_for('static', filename='js/theme-loader.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">

    <!-- Aggressive Translation System -->
    <script src="{{ url_for('static', filename='js/aggressive-translator.js') }}"></script>
</head>
<body>
    <!-- Header -->
    <div id="app-header">
        <div class="header-content">
            <div class="header-left">
                <div class="logo-container">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" class="header-logo">
                </div>
                <div class="title-container">
                    <h1>{% if user_type == 'admin' %}<span data-i18n="adminDashboard">Admin Dashboard</span>{% else %}<span data-i18n="dashboard">Dashboard</span>{% endif %}</h1>
                    <h2 data-i18n="appTitle">Drone Application & Research Center</h2>
                </div>
            </div>
            <div class="header-right">
                <div class="nav-links">
                    <a href="/" class="nav-link">
                        <i class="fas fa-map"></i> <span data-i18n="mapView">Map View</span>
                    </a>
                    <a href="/dashboard" class="nav-link active">
                        <i class="fas fa-tachometer-alt"></i> <span data-i18n="dashboard">Dashboard</span>
                    </a>
                    <a href="/profile" class="nav-link">
                        <i class="fas fa-user-circle"></i> <span data-i18n="profile">Profile</span>
                    </a>
                </div>
                <div class="user-info">
                    <span class="welcome-text"><span data-i18n="welcome">Welcome</span>, {{ session.username }}</span>
                    <a href="/logout" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">Logout</span>
                    </a>
                </div>
                <div class="language-switch">
                    <button id="lang-en" class="lang-btn active">English</button>
                    <button id="lang-hi" class="lang-btn">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-container">

        <!-- Enhanced System Status Bar - Full Width -->
        <div class="system-status-bar">
            <div class="status-item">
                <div class="status-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="status-content">
                    <span class="status-value">2</span>
                    <span class="status-label">Active Users</span>
                    <span class="status-change negative">-50%</span>
                    <div class="status-indicator">
                        <span class="indicator-dot live"></span>
                        <span class="indicator-text">Live</span>
                    </div>
                    <span class="status-stability">Stable</span>
                </div>
            </div>

            <div class="status-item">
                <div class="status-icon">
                    <i class="fas fa-server"></i>
                </div>
                <div class="status-content">
                    <span class="status-value">341ms</span>
                    <span class="status-label">API Response</span>
                    <span class="status-change positive">-12%</span>
                    <div class="status-indicator">
                        <span class="indicator-dot live"></span>
                        <span class="indicator-text">Live</span>
                    </div>
                    <span class="status-stability">Stable</span>
                </div>
            </div>

            <div class="status-item">
                <div class="status-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="status-content">
                    <span class="status-value">98.3%</span>
                    <span class="status-label">Uptime</span>
                    <span class="status-change positive">+0.1%</span>
                    <div class="status-indicator">
                        <span class="indicator-dot live"></span>
                        <span class="indicator-text">Live</span>
                    </div>
                    <span class="status-stability">Stable</span>
                </div>
            </div>

            <div class="status-item">
                <div class="status-icon">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="status-content">
                    <span class="status-value">33%</span>
                    <span class="status-label">Engagement</span>
                    <span class="status-change positive">+5%</span>
                    <div class="status-indicator">
                        <span class="indicator-dot live"></span>
                        <span class="indicator-text">Live</span>
                    </div>
                    <span class="status-stability">Stable</span>
                </div>
            </div>
        </div>

        <!-- Modern System Status Bar -->
        <div class="modern-status-bar">
            <div class="status-pill" id="api-status">
                <span class="status-dot online"></span>
                <span class="status-text">API</span>
            </div>
            <div class="status-pill" id="database-status">
                <span class="status-dot online"></span>
                <span class="status-text">DATABASE</span>
            </div>
            <div class="status-pill" id="frontend-status">
                <span class="status-dot online"></span>
                <span class="status-text">FRONTEND</span>
            </div>
            <div class="status-pill" id="analytics-status">
                <span class="status-dot online"></span>
                <span class="status-text">ANALYTICS</span>
            </div>
            <div class="status-pill" id="notifications-status">
                <span class="status-dot online"></span>
                <span class="status-text">NOTIFICATIONS</span>
            </div>
            <div class="status-actions">
                <span class="last-updated" id="last-updated">Last updated: <span id="update-time">12:26:29 AM</span></span>
                <button class="refresh-btn" onclick="refreshSystemStatus()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>



        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- System Monitoring - Full Width -->
            <div class="dashboard-card full-width storage-monitoring">
                <div class="card-header">
                    <h3><i class="fas fa-desktop"></i> <span data-i18n="systemPerformanceMonitor">System Performance Monitor</span></h3>
                    <div class="monitor-controls">
                        <span class="update-frequency"><span data-i18n="update">Update</span>: <span id="update-timer">1s</span></span>
                        <button class="refresh-btn" onclick="refreshStorageData()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="fullscreen-btn" onclick="toggleFullscreen()">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <!-- Real-time Performance Metrics -->
                    <div class="performance-grid">
                        <!-- CPU Monitor -->
                        <div class="performance-widget">
                            <div class="widget-header">
                                <h4><i class="fas fa-microchip"></i> CPU</h4>
                                <span class="current-value" id="cpu-current">45%</span>
                            </div>
                            <div class="mini-chart-container">
                                <canvas id="cpuMiniChart" width="200" height="60"></canvas>
                            </div>
                            <div class="widget-details">
                                <div class="detail-item">
                                    <span>Speed:</span>
                                    <span id="cpu-speed">3.2 GHz</span>
                                </div>
                                <div class="detail-item">
                                    <span>Cores:</span>
                                    <span id="cpu-cores">8</span>
                                </div>
                                <div class="detail-item">
                                    <span>Processes:</span>
                                    <span id="cpu-processes">247</span>
                                </div>
                            </div>
                        </div>

                        <!-- Memory Monitor -->
                        <div class="performance-widget">
                            <div class="widget-header">
                                <h4><i class="fas fa-memory"></i> Memory</h4>
                                <span class="current-value" id="memory-current">14.7GB / 31.6GB</span>
                            </div>
                            <div class="mini-chart-container">
                                <canvas id="memoryMiniChart" width="200" height="60"></canvas>
                            </div>
                            <div class="widget-details">
                                <div class="detail-item">
                                    <span>Available:</span>
                                    <span id="memory-available">16.9 GB</span>
                                </div>
                                <div class="detail-item">
                                    <span>Cached:</span>
                                    <span id="memory-cached">8.2 GB</span>
                                </div>
                                <div class="detail-item">
                                    <span>In Use:</span>
                                    <span id="memory-used">14.7 GB</span>
                                </div>
                            </div>
                        </div>

                        <!-- Disk Monitor -->
                        <div class="performance-widget">
                            <div class="widget-header">
                                <h4><i class="fas fa-hdd"></i> Disk</h4>
                                <span class="current-value" id="disk-current">211.7GB / 317.8GB</span>
                            </div>
                            <div class="mini-chart-container">
                                <canvas id="diskMiniChart" width="200" height="60"></canvas>
                            </div>
                            <div class="widget-details">
                                <div class="detail-item">
                                    <span>Read:</span>
                                    <span id="disk-read">45 MB/s</span>
                                </div>
                                <div class="detail-item">
                                    <span>Write:</span>
                                    <span id="disk-write">23 MB/s</span>
                                </div>
                                <div class="detail-item">
                                    <span>Active Time:</span>
                                    <span id="disk-active">12%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Network Monitor -->
                        <div class="performance-widget">
                            <div class="widget-header">
                                <h4><i class="fas fa-wifi"></i> Network</h4>
                                <span class="current-value" id="network-current">12 MB/s</span>
                            </div>
                            <div class="mini-chart-container">
                                <canvas id="networkMiniChart" width="200" height="60"></canvas>
                            </div>
                            <div class="widget-details">
                                <div class="detail-item">
                                    <span>Download:</span>
                                    <span id="network-download">8.5 MB/s</span>
                                </div>
                                <div class="detail-item">
                                    <span>Upload:</span>
                                    <span id="network-upload">3.5 MB/s</span>
                                </div>
                                <div class="detail-item">
                                    <span>Latency:</span>
                                    <span id="network-latency">12ms</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Performance Chart -->
                    <div class="main-chart-container">
                        <div class="chart-header">
                            <h4>Performance History (Last 60 seconds)</h4>
                            <div class="chart-legend">
                                <span class="legend-item cpu"><i class="fas fa-circle"></i> CPU</span>
                                <span class="legend-item memory"><i class="fas fa-circle"></i> Memory</span>
                                <span class="legend-item disk"><i class="fas fa-circle"></i> Disk</span>
                                <span class="legend-item network"><i class="fas fa-circle"></i> Network</span>
                            </div>
                        </div>
                        <canvas id="performanceChart" width="800" height="300"></canvas>
                    </div>


                </div>
            </div>



            <!-- User Activity & Performance Analytics Card -->
            <div class="dashboard-card full-width analytics-card">
                <div class="card-header">
                    <h3><i class="fas fa-chart-line"></i> User Activity & Performance Analytics</h3>
                </div>

                <!-- Full-width horizontal controls bar -->
                <div class="analytics-controls-bar">
                    <div class="time-range-selector">
                        <button class="time-range-btn active" data-range="24h">24h</button>
                        <button class="time-range-btn" data-range="7d">7d</button>
                        <button class="time-range-btn" data-range="30d">30d</button>
                        <button class="time-range-btn" data-range="custom">Custom</button>
                    </div>
                    <div class="analytics-actions">
                        <button class="analytics-action-btn" onclick="exportAnalytics()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="analytics-action-btn" onclick="refreshAnalytics()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="card-content">

                    <!-- Quick Stats Row Removed - Using top dashboard stats instead -->

                    <!-- Charts Section -->
                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h4>User Activity</h4>
                                <div class="chart-legend">
                                    <span class="legend-item"><span class="legend-color active-users"></span>Active Users</span>
                                    <span class="legend-item"><span class="legend-color page-views"></span>Page Views</span>
                                </div>
                            </div>
                            <canvas id="user-activity-chart"></canvas>
                        </div>
                        <div class="chart-container">
                            <div class="chart-header">
                                <h4>Performance Metrics</h4>
                                <div class="chart-legend">
                                    <span class="legend-item"><span class="legend-color load-time"></span>Load Time</span>
                                    <span class="legend-item"><span class="legend-color response-time"></span>API Response</span>
                                </div>
                            </div>
                            <canvas id="performance-chart"></canvas>
                        </div>



                    </div>
                </div>
            </div>

            <!-- Project Performance and Alerts Side by Side -->
            <div class="two-column-container">
                <!-- Project Performance Card (placeholder) -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-tasks"></i> Project Performance</h3>
                        <button class="refresh-btn" onclick="refreshProjectData()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="card-content">
                        <div class="project-summary">
                            <canvas id="projectChart" width="400" height="200"></canvas>
                        </div>
                        <div class="project-list" id="project-list">
                            <!-- Projects will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Alerts and Notifications Card -->
                <div class="dashboard-card">
                <div class="card-header">
                    <h3><i class="fas fa-bell"></i> Alerts & Notifications</h3>
                </div>
                <div class="notification-controls-row">
                    <button class="notification-control-btn" onclick="clearAllAlerts()">
                        <i class="fas fa-check"></i> Mark Read
                    </button>
                    <button class="notification-control-btn" onclick="deleteReadNotifications()">
                        <i class="fas fa-trash"></i> Delete Read
                    </button>
                    <button class="notification-control-btn" onclick="showAddNotificationModal()">
                        <i class="fas fa-plus"></i> Add
                    </button>
                    <button class="notification-control-btn" onclick="testFirebaseConnection()">
                        <i class="fas fa-plug"></i> Test
                    </button>
                    <button class="notification-control-btn" onclick="refreshNotifications()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-content">
                    <!-- Notification Filters -->
                    <div class="notification-filters">
                        <div class="filter-group">
                            <label>Filter by Type:</label>
                            <select id="filter-type" onchange="filterNotifications()">
                                <option value="all">All Types</option>
                                <option value="info">Info</option>
                                <option value="success">Success</option>
                                <option value="warning">Warning</option>
                                <option value="error">Error</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Filter by Status:</label>
                            <select id="filter-status" onchange="filterNotifications()">
                                <option value="all">All</option>
                                <option value="unread">Unread Only</option>
                                <option value="read">Read Only</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Filter by Priority:</label>
                            <select id="filter-priority" onchange="filterNotifications()">
                                <option value="all">All Priorities</option>
                                <option value="critical">Critical</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                    </div>

                    <!-- Notification Stats -->
                    <div class="notification-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total:</span>
                            <span class="stat-value" id="total-notifications">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Unread:</span>
                            <span class="stat-value" id="unread-notifications">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Critical:</span>
                            <span class="stat-value critical" id="critical-notifications">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">System:</span>
                            <span class="stat-value" id="system-status">
                                <i class="fas fa-circle"></i> Checking...
                            </span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Auto-Monitor:</span>
                            <span class="stat-value" id="monitor-status">
                                <i class="fas fa-circle text-success"></i> Active
                            </span>
                        </div>
                    </div>

                    <div class="alerts-container" id="alerts-container">
                        <!-- Alerts will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Role Management - Full Width (Admin Only) -->
            {% if user_type == 'admin' %}
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h3><i class="fas fa-user-cog"></i> <span data-i18n="userManagement">User Management & Role Administration</span></h3>
                    <div class="header-actions">
                        <button class="add-user-btn" onclick="showAddUserModal()">
                            <i class="fas fa-plus"></i> <span data-i18n="addUser">Add User</span>
                        </button>
                        <span class="pending-count" id="pending-count">0 <span data-i18n="pending">Pending</span></span>
                    </div>
                </div>
                <div class="card-content">
                    <div class="users-table-container">
                        <table class="users-table" id="users-table">
                            <thead>
                                <tr>
                                    <th data-i18n="username">Username</th>
                                    <th data-i18n="email">Email</th>
                                    <th data-i18n="role">Role</th>
                                    <th data-i18n="status">Status</th>
                                    <th data-i18n="lastLogin">Last Login</th>
                                    <th data-i18n="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <tr>
                                    <td colspan="6" class="loading-message">
                                        <i class="fas fa-spinner fa-spin"></i> Loading users...
                                    </td>
                                </tr>
                            </tbody>
                            <script>
                                // Auto-load users when admin section renders
                                function loadUsersImmediate() {
                                    fetch('/api/dashboard/users')
                                        .then(response => response.json())
                                        .then(data => {
                                            const tableBody = document.getElementById('users-table-body');
                                            if (tableBody && data.users) {
                                                tableBody.innerHTML = '';

                                                data.users.forEach(user => {
                                                    const row = document.createElement('tr');
                                                    const lastLogin = new Date(user.last_login).toLocaleDateString();

                                                    row.innerHTML = `
                                                        <td>${user.username}</td>
                                                        <td>${user.email}</td>
                                                        <td><span class="user-role ${user.role}">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</span></td>
                                                        <td><span class="user-status ${user.status}">${user.status.charAt(0).toUpperCase() + user.status.slice(1)}</span></td>
                                                        <td>${lastLogin}</td>
                                                        <td>
                                                            <button class="action-btn edit-btn" onclick="editUser('${user.id}')" title="Edit User">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button class="action-btn delete-btn" onclick="deleteUser('${user.id}')" title="Delete User">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </td>
                                                    `;
                                                    tableBody.appendChild(row);
                                                });

                                                // Fix action button icons
                                                setTimeout(() => {
                                                    if (typeof fixActionButtonIcons === 'function') {
                                                        fixActionButtonIcons();
                                                    }
                                                }, 200);
                                            }
                                        })
                                        .catch(error => {
                                            console.error('Error loading users:', error);
                                        });
                                }

                                // Execute immediately
                                loadUsersImmediate();
                            </script>
                        </table>
                    </div>
                    <div class="pending-users-container" id="pending-users-container">
                        <!-- Pending users will be loaded here -->
                    </div>
                </div>
            </div>
            {% endif %}
            </div> <!-- End two-column-container -->

        </div>
    </div>

    <!-- Event Triggers Modal -->
    <div id="event-triggers-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Test Event Triggers</h3>
                <span class="close" onclick="closeEventTriggersModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="trigger-section">
                    <h4><i class="fas fa-users"></i> User Events</h4>
                    <div class="trigger-buttons">
                        <button class="trigger-btn" onclick="triggerUserRegistration()">
                            <i class="fas fa-user-plus"></i> New User Registration
                        </button>
                        <button class="trigger-btn" onclick="triggerLoginFailed()">
                            <i class="fas fa-times-circle"></i> Failed Login
                        </button>
                        <button class="trigger-btn" onclick="triggerAdminLogin()">
                            <i class="fas fa-sign-in-alt"></i> Admin Login
                        </button>
                        <button class="trigger-btn" onclick="triggerRoleChange()">
                            <i class="fas fa-user-cog"></i> Role Change
                        </button>
                    </div>
                </div>

                <div class="trigger-section">
                    <h4><i class="fas fa-shield-alt"></i> Security Events</h4>
                    <div class="trigger-buttons">
                        <button class="trigger-btn" onclick="triggerUnauthorizedAccess()">
                            <i class="fas fa-ban"></i> Unauthorized Access
                        </button>
                        <button class="trigger-btn" onclick="triggerSuspiciousActivity()">
                            <i class="fas fa-exclamation-triangle"></i> Suspicious Activity
                        </button>
                    </div>
                </div>

                <div class="trigger-section">
                    <h4><i class="fas fa-server"></i> System Events</h4>
                    <div class="trigger-buttons">
                        <button class="trigger-btn" onclick="triggerHighCPU()">
                            <i class="fas fa-microchip"></i> High CPU Usage
                        </button>
                        <button class="trigger-btn" onclick="triggerLowDisk()">
                            <i class="fas fa-hdd"></i> Low Disk Space
                        </button>
                        <button class="trigger-btn" onclick="triggerBackupComplete()">
                            <i class="fas fa-check-circle"></i> Backup Complete
                        </button>
                        <button class="trigger-btn" onclick="triggerMaintenanceAlert()">
                            <i class="fas fa-tools"></i> Maintenance Alert
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeEventTriggersModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Notification Modal -->
    <div id="notification-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Notification</h3>
                <span class="close" onclick="closeNotificationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="notification-form">
                    <div class="form-group">
                        <label for="notification-type">Type:</label>
                        <select id="notification-type" required>
                            <option value="info">Info</option>
                            <option value="success">Success</option>
                            <option value="warning">Warning</option>
                            <option value="error">Error</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="notification-priority">Priority:</label>
                        <select id="notification-priority" required>
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="notification-category">Category:</label>
                        <select id="notification-category" required>
                            <option value="system">System</option>
                            <option value="user">User</option>
                            <option value="security">Security</option>
                            <option value="maintenance">Maintenance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="notification-title">Title:</label>
                        <input type="text" id="notification-title" required maxlength="100">
                    </div>
                    <div class="form-group">
                        <label for="notification-message">Message:</label>
                        <textarea id="notification-message" required rows="3" maxlength="500"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="notification-action-url">Action URL (optional):</label>
                        <input type="url" id="notification-action-url" placeholder="https://example.com/action">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeNotificationModal()">Cancel</button>
                <button type="button" class="btn-primary" onclick="createNotification()">Create Notification</button>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Edit User</h3>
                <span class="close" onclick="closeUserModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="user-form">
                    <input type="hidden" id="user-id">
                    <div class="form-group">
                        <label for="user-username" data-i18n="username">Username:</label>
                        <input type="text" id="user-username" required>
                    </div>
                    <div class="form-group">
                        <label for="user-email" data-i18n="email">Email:</label>
                        <input type="email" id="user-email" required>
                    </div>
                    <div class="form-group">
                        <label for="user-fullname" data-i18n="fullName">Full Name:</label>
                        <input type="text" id="user-fullname" required>
                    </div>
                    <div class="form-group">
                        <label for="user-password" data-i18n="password">Password:</label>
                        <input type="password" id="user-password" placeholder="Leave blank to keep current password" maxlength="50">
                        <small>Required for new users, optional for existing users</small>
                    </div>
                    <div class="form-group">
                        <label for="user-role" data-i18n="role">Role:</label>
                        <select id="user-role" required>
                            <option value="user" data-i18n="user">User</option>
                            <option value="analyst" data-i18n="analyst">Analyst</option>
                            <option value="admin" data-i18n="admin">Admin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="user-status" data-i18n="status">Status:</label>
                        <select id="user-status" required>
                            <option value="approved" data-i18n="approved">Approved</option>
                            <option value="suspended" data-i18n="suspended">Suspended</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeUserModal()" data-i18n="cancel">Cancel</button>
                <button type="button" class="btn-primary" onclick="saveUser()" data-i18n="save">Save</button>
            </div>
        </div>
    </div>

    <!-- Pass user type to JavaScript -->
    <script>
        // Make user type available to JavaScript
        window.USER_TYPE = '{{ user_type }}';
        window.USERNAME = '{{ session.username }}';
        console.log('üîç User type from template:', window.USER_TYPE);
        console.log('üîç Username from template:', window.USERNAME);
    </script>

    <!-- Custom JavaScript -->
    <script src="{{ url_for('static', filename='js/firebase-config.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    <script src="{{ url_for('static', filename='js/system-monitor.js') }}"></script>
    <script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
    <script src="{{ url_for('static', filename='js/notification-triggers.js') }}"></script>
    <script src="{{ url_for('static', filename='js/system-health.js') }}"></script>
    <!-- Auto-notifications disabled to reduce server load -->
    <!-- <script src="{{ url_for('static', filename='js/auto-notifications.js') }}"></script> -->

    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Initialization Manager (MUST BE FIRST) -->
    <script src="{{ url_for('static', filename='js/init-manager.js') }}"></script>

    <!-- Real Analytics System -->
    <script src="{{ url_for('static', filename='js/real-analytics.js') }}"></script>
    <script src="{{ url_for('static', filename='js/real-analytics-processor.js') }}"></script>

    <!-- Enhanced Performance Monitoring (Disabled to reduce server load) -->
    <!-- <script src="{{ url_for('static', filename='js/performance-monitor.js') }}"></script> -->
    <!-- <script src="{{ url_for('static', filename='js/error-tracker.js') }}"></script> -->

    <!-- Advanced User Interaction Analytics (Disabled to reduce server load) -->
    <!-- <script src="{{ url_for('static', filename='js/interaction-tracker.js') }}"></script> -->
    <!-- <script src="{{ url_for('static', filename='js/journey-analyzer.js') }}"></script> -->

    <!-- Analytics Dashboard -->
    <script src="{{ url_for('static', filename='js/analytics.js') }}"></script>

    <!-- Toast Notifications -->
    <script src="{{ url_for('static', filename='js/toast-notifications.js') }}"></script>

    <!-- Real-time Dashboard Integration -->
    <script src="{{ url_for('static', filename='js/realtime-dashboard.js') }}"></script>
    <script src="{{ url_for('static', filename='js/system-status-monitor.js') }}"></script>





    <!-- System Status Functions -->
    <script>
        // System status refresh function
        function refreshSystemStatus() {
            console.log('üîÑ Refreshing system status...');

            // Show loading state
            const refreshBtn = document.querySelector('.refresh-btn');
            if (refreshBtn) {
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                refreshBtn.disabled = true;
            }

            // Simulate API calls and update status
            setTimeout(() => {
                updateSystemStatus();

                if (refreshBtn) {
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                    refreshBtn.disabled = false;
                }

                // Update timestamp
                const timeElement = document.getElementById('update-time');
                if (timeElement) {
                    timeElement.textContent = new Date().toLocaleTimeString();
                }

                if (typeof showToast === 'function') {
                    showToast('System status refreshed!', 'success');
                }
            }, 1500);
        }

        // Status persistence to prevent rapid changes
        let lastStatusUpdate = {};
        let statusStabilityCounter = 0;

        // Update system status indicators with stability
        function updateSystemStatus() {
            // Increment stability counter
            statusStabilityCounter++;

            // Only allow status changes every 5 updates (5 minutes) for stability
            const allowStatusChange = statusStabilityCounter % 5 === 0;

            // Very stable status simulation - mostly online with rare warnings
            const statusItems = [
                {
                    id: 'api-status',
                    status: allowStatusChange && Math.random() > 0.98 ? 'warning' : (lastStatusUpdate['api-status'] || 'online')
                },
                {
                    id: 'database-status',
                    status: allowStatusChange && Math.random() > 0.99 ? 'warning' : (lastStatusUpdate['database-status'] || 'online')
                },
                {
                    id: 'frontend-status',
                    status: 'online' // Always online
                },
                {
                    id: 'analytics-status',
                    status: allowStatusChange && Math.random() > 0.97 ? 'warning' : (lastStatusUpdate['analytics-status'] || 'online')
                },
                {
                    id: 'notifications-status',
                    status: 'online' // Always online
                }
            ];

            // Update last status for persistence
            statusItems.forEach(item => {
                lastStatusUpdate[item.id] = item.status;
            });

            statusItems.forEach(item => {
                const element = document.getElementById(item.id);
                if (element) {
                    const dot = element.querySelector('.status-dot');
                    const text = element.querySelector('.status-text');

                    // Store original text content to prevent overwriting
                    if (!text.dataset.originalText) {
                        text.dataset.originalText = text.textContent;
                    }

                    // Remove existing status classes
                    dot.classList.remove('online', 'offline', 'warning');
                    text.classList.remove('online', 'offline', 'warning');

                    // Add new status
                    dot.classList.add(item.status);
                    text.classList.add(item.status);

                    // Ensure text content remains unchanged (prevent "DEGRADED" override)
                    text.textContent = text.dataset.originalText;

                    // Update pill background based on status
                    if (item.status === 'online') {
                        element.style.borderColor = 'rgba(40, 167, 69, 0.3)';
                        element.style.background = 'rgba(40, 167, 69, 0.1)';
                    } else if (item.status === 'warning') {
                        element.style.borderColor = 'rgba(255, 193, 7, 0.3)';
                        element.style.background = 'rgba(255, 193, 7, 0.1)';
                    } else {
                        element.style.borderColor = 'rgba(220, 53, 69, 0.3)';
                        element.style.background = 'rgba(220, 53, 69, 0.1)';
                    }
                }
            });
        }

        // Auto-refresh system status every 60 seconds (reduced frequency)
        function startLiveStatusUpdates() {
            // Initial update
            updateSystemStatus();

            // Set up auto-refresh with longer interval for stability
            setInterval(() => {
                updateSystemStatus();
                const timeElement = document.getElementById('update-time');
                if (timeElement) {
                    timeElement.textContent = new Date().toLocaleTimeString();
                }
            }, 300000); // Update every 5 minutes to reduce server load
        }

        // Fix action button icons
        function fixActionButtonIcons() {
            const actionButtons = document.querySelectorAll('.action-btn');
            actionButtons.forEach(btn => {
                const icon = btn.querySelector('i');
                if (icon) {
                    // Ensure proper Font Awesome classes
                    if (!icon.classList.contains('fas') && !icon.classList.contains('fa')) {
                        icon.classList.add('fas');
                    }

                    // Force icon visibility
                    icon.style.display = 'inline-block';
                    icon.style.fontFamily = '"Font Awesome 6 Free"';
                    icon.style.fontWeight = '900';

                    // Add fallback text if icon doesn't load
                    if (icon.classList.contains('fa-edit')) {
                        icon.setAttribute('data-fallback', '‚úèÔ∏è');
                    } else if (icon.classList.contains('fa-trash')) {
                        icon.setAttribute('data-fallback', 'üóëÔ∏è');
                    }
                }
            });
        }

        // Start live updates when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the dashboard
            if (typeof initializeDashboard === 'function') {
                initializeDashboard();
            }

            // Setup auto refresh
            if (typeof setupAutoRefresh === 'function') {
                setupAutoRefresh();
            }



            startLiveStatusUpdates();

            // Fix action button icons
            setTimeout(() => {
                fixActionButtonIcons();
            }, 500);

            // Remove any existing system status widgets
            setTimeout(() => {
                const existingWidgets = document.querySelectorAll('#system-status-widget, .system-status-widget');
                existingWidgets.forEach(widget => {
                    console.log('üóëÔ∏è Removing old system status widget');
                    widget.remove();
                });
            }, 1000);
        });

        // User Management Functions are handled by dashboard.js


    </script>

    <!-- Frontend Activity Tracking -->
    <script>
    // Frontend interaction tracking for real-time analytics
    class FrontendTracker {
        constructor() {
            this.pageStartTime = Date.now();
            this.setupEventListeners();
            console.log('üìä Frontend activity tracking initialized');
        }

        setupEventListeners() {
            // Track clicks on important elements
            document.addEventListener('click', (e) => {
                if (e.target.matches('button, .nav-link, .card-header, .time-range-btn')) {
                    this.trackInteraction('click', this.getElementSelector(e.target));
                }
            });

            // Track form submissions
            document.addEventListener('submit', (e) => {
                this.trackInteraction('form_submit', this.getElementSelector(e.target));
            });

            // Track page unload (time spent)
            window.addEventListener('beforeunload', () => {
                const timeSpent = Math.round((Date.now() - this.pageStartTime) / 1000);
                this.trackPageTime(timeSpent);
            });
        }

        trackInteraction(type, element, metadata = {}) {
            fetch('/api/track/interaction', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: type,
                    element: element,
                    metadata: metadata
                })
            }).catch(console.error);
        }

        trackPageTime(timeSpent) {
            if (navigator.sendBeacon) {
                navigator.sendBeacon('/api/track/page-time', JSON.stringify({
                    page_url: window.location.pathname,
                    time_spent: timeSpent
                }));
            }
        }

        getElementSelector(element) {
            if (element.id) return `#${element.id}`;
            if (element.className) return `.${element.className.split(' ')[0]}`;
            return element.tagName.toLowerCase();
        }
    }

    // Initialize tracker when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        new FrontendTracker();
    });
    </script>
</body>
</html>
